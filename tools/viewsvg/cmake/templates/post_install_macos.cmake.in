# Simple post-install script for macOS
# Variables substituted by configure_file
set(PROJECT_NAME "@PROJECT_NAME@")
set(CMAKE_INSTALL_BINDIR "@CMAKE_INSTALL_BINDIR@")
set(CMAKE_SOURCE_DIR "@CMAKE_SOURCE_DIR@")
set(MACDEPLOYQT_EXECUTABLE "@MACDEPLOYQT_EXECUTABLE@")
set(QT_INSTALL_DIR "@QT_INSTALL_DIR@")
set(PROJECT_BINARY_DIR "@PROJECT_BINARY_DIR@")

message(STATUS "Running macdeployqt...")

# macOS app bundle path is different - need to find the .app directory
set(INSTALLED_APP "${CMAKE_INSTALL_PREFIX}/${CMAKE_INSTALL_BINDIR}/${PROJECT_NAME}.app")

# Try different possible paths for QML directory
set(POSSIBLE_QML_DIRS
    "${CMAKE_SOURCE_DIR}/qml"
    "${CMAKE_SOURCE_DIR}"
    "${PROJECT_BINARY_DIR}/qml"
    "${PROJECT_BINARY_DIR}"
)

set(QML_DIR "")
foreach(dir ${POSSIBLE_QML_DIRS})
    if(EXISTS "${dir}" AND EXISTS "${dir}/Main.qml")
        set(QML_DIR "${dir}")
        message(STATUS "Found QML directory: ${QML_DIR}")
        break()
    elseif(EXISTS "${dir}")
        # Look for QML files in subdirectories
        file(GLOB_RECURSE qml_files "${dir}/*.qml")
        if(qml_files)
            set(QML_DIR "${dir}")
            message(STATUS "Found QML directory with QML files: ${QML_DIR}")
            break()
        endif()
    endif()
endforeach()

if(NOT QML_DIR)
    message(WARNING "Could not find QML directory with QML files. macdeployqt might not work properly.")
    # Try to run without explicit QML directory
    execute_process(
        COMMAND "${CMAKE_COMMAND}" -E env PATH="${QT_INSTALL_DIR}/bin"
            "${MACDEPLOYQT_EXECUTABLE}" "${INSTALLED_APP}" -always-overwrite
        RESULT_VARIABLE result
        OUTPUT_VARIABLE output
        ERROR_VARIABLE error
    )
else()
    # Run macdeployqt on the installed app bundle with the found QML directory
    execute_process(
        COMMAND "${CMAKE_COMMAND}" -E env PATH="${QT_INSTALL_DIR}/bin"
            "${MACDEPLOYQT_EXECUTABLE}" "${INSTALLED_APP}"
            -qmldir "${QML_DIR}" -always-overwrite
        RESULT_VARIABLE result
        OUTPUT_VARIABLE output
        ERROR_VARIABLE error
    )
endif()

if(NOT result EQUAL 0)
    message(WARNING "macdeployqt failed: ${error}")
else()
    message(STATUS "macdeployqt completed successfully")
endif()

# Debug output
message(STATUS "macdeployqt output: ${output}")
if(error)
    message(STATUS "macdeployqt error: ${error}")
endif()
